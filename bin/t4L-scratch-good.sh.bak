#!/usr/bin/env bash
set -euo pipefail

# KONFIG
TERM_CLASS="kitty"
TERM_TITLE="scratchpad"
HIDDEN_WS="name:_scratchpad_hidden"
WIN_W=1200
WIN_H=700

have_jq() { command -v jq >/dev/null 2>&1; }

# 1) Jeśli terminal nie działa → uruchom, pokaż i WYJDŹ (nie chowaj przy pierwszym razie)
if ! pgrep -fa "${TERM_CLASS}.*--title ${TERM_TITLE}" >/dev/null 2>&1; then
  ${TERM_CLASS} --title "${TERM_TITLE}" & disown

  # Czekaj aż okno się pojawi (max 2 sekundy)
  for _ in {1..20}; do
    sleep 0.1
    win_json=$(hyprctl clients -j | jq -c --arg t "${TERM_TITLE}" --arg c "${TERM_CLASS}" \
      '.[] | select(.title==$t) | select(.class==$c)')
    if [[ -n "$win_json" ]]; then
      break
    fi
  done

  # Upewnij się, że ma fokus
  hyprctl dispatch focuswindow title:"${TERM_TITLE}" || true

  if have_jq && [[ -n "$win_json" ]]; then
    win_addr=$(jq -r '.address' <<<"$win_json")
    hyprctl dispatch setfloating on address:"${win_addr}"
    hyprctl dispatch resizewindowpixel exact $WIN_W $WIN_H address:"${win_addr}"
    hyprctl dispatch centerwindow
  fi
  exit 0
fi

# 2) Dalej: toggle show/hide istniejącego okna
if ! have_jq; then
  # bez jq tylko pokaż
  hyprctl dispatch focuswindow title:"${TERM_TITLE}" || true
  exit 0
fi

win_json=$(hyprctl clients -j | jq -c --arg t "${TERM_TITLE}" --arg c "${TERM_CLASS}" \
  '.[] | select(.title==$t) | select(.class==$c)')

if [[ -z "${win_json}" ]]; then
  # nie znaleziono → spróbuj uruchomić i wyjść
  ${TERM_CLASS} --title "${TERM_TITLE}" & disown

  for _ in {1..20}; do
    sleep 0.1
    win_json=$(hyprctl clients -j | jq -c --arg t "${TERM_TITLE}" --arg c "${TERM_CLASS}" \
      '.[] | select(.title==$t) | select(.class==$c)')
    if [[ -n "$win_json" ]]; then
      break
    fi
  done

  hyprctl dispatch focuswindow title:"${TERM_TITLE}" || true

  if [[ -n "$win_json" ]]; then
    win_addr=$(jq -r '.address' <<<"$win_json")
    hyprctl dispatch setfloating on address:"${win_addr}"
    hyprctl dispatch resizewindowpixel exact $WIN_W $WIN_H address:"${win_addr}"
    hyprctl dispatch centerwindow
  fi
  exit 0
fi

win_addr=$(jq -r '.address' <<<"$win_json")
win_ws_id=$(jq -r '.workspace.id' <<<"$win_json")
active_ws_id=$(hyprctl activeworkspace -j | jq -r '.id')

# Jeśli okno jest na aktywnym WS → SCHOWAJ (przenieś na ukryty WS)
if [[ "${win_ws_id}" == "${active_ws_id}" ]]; then
  hyprctl dispatch movetoworkspacesilent "${HIDDEN_WS}",address:"${win_addr}"
  hyprctl dispatch cyclenext || true
  exit 0
fi

# Jeśli okno jest gdzie indziej (w tym na ukrytym) → POKAŻ na bieżącym WS
hyprctl dispatch movetoworkspacesilent "${active_ws_id}",address:"${win_addr}"
hyprctl dispatch focuswindow address:"${win_addr}"
hyprctl dispatch setfloating on address:"${win_addr}"
hyprctl dispatch resizewindowpixel exact $WIN_W $WIN_H address:"${win_addr}"
hyprctl dispatch centerwindow
hyprctl dispatch bringactivetotop || true

